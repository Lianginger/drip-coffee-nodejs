<main style="background-color: #f6f6f7; min-height: 100vh">
  <div class="container">
    <h1 class="text-center py-5 font-weight-bold">All platform crawler status</h1>
    {{#each crawlerStatus}}
    <section class="py-2">
      <div class="d-flex align-items-center my-2" data-toggle="collapse" data-target="#platform-{{platformId}}"
        style="cursor: pointer;">
        <h4 class="font-weight-bold m-0">
          {{this.platformTitle}}</h4>
        {{#if this.numberOfNoLatestDataProject}}
        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-x-circle-fill mx-3" fill="currentColor"
          xmlns="http://www.w3.org/2000/svg" style="color: red;">
          <path fill-rule="evenodd"
            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z" />
        </svg>
        {{else}}
        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-check-circle-fill mx-3" fill="currentColor"
          xmlns="http://www.w3.org/2000/svg" style="color: green;">
          <path fill-rule="evenodd"
            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
        </svg>
        {{/if}}

      </div>

      <div class="card collapse" id="platform-{{platformId}}">
        <div class="card-body">
          <table class="table">
            <thead>
              <tr style="white-space: nowrap;">
                <th scope="col">檢查時間點</th>
                <th scope="col">總在線專案</th>
                <th scope="col">通過</th>
                <th scope="col">找不到</th>
                <th scope="col">已結束</th>
                <th scope="col">有問題</th>
                <th scope="col">耗時(秒)</th>
              </tr>
            </thead>
            <tbody>
              {{#each this.records}}
              <tr>
                <th scope="row"><span class="badge badge-light">{{this.dateTimeToCheck}}</span></th>
                <td><span class="badge badge-pill badge-light">{{this.numberOfLiveProject}}</span></td>
                <td><span class="badge badge-pill badge-success">{{this.numberOfPassedProject}}</span></td>
                <td><span class="badge badge-pill badge-warning js-problem-project-badge"
                    data-platform-id="{{this.platformId}}" data-problem-type="not-found"
                    data-number-of-problem-project="{{this.numberOfNotFoundProject}}"
                    style="cursor: pointer;">{{this.numberOfNotFoundProject}}</span>
                </td>
                <td><span class="badge badge-pill badge-secondary js-problem-project-badge"
                    data-platform-id="{{this.platformId}}" data-problem-type="closed"
                    data-number-of-problem-project="{{this.numberOfClosedProject}}"
                    style="cursor: pointer;">{{this.numberOfClosedProject}}</span>
                </td>
                <td><span class="badge badge-pill badge-danger js-problem-project-badge"
                    data-platform-id="{{this.platformId}}" data-problem-type="no-latest-data"
                    data-number-of-problem-project="{{this.numberOfNoLatestDataProject}}"
                    style="cursor: pointer;">{{this.numberOfNoLatestDataProject}}</span>
                </td>
                <td>
                  {{this.timeSpend}}
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      </div>
    </section>
    {{/each}}
  </div>
  <!-- Modal -->
  <div class="modal fade" id="modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title font-weight-bold" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
      </div>
    </div>
  </div>
</main>
<!-- JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
  integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
  integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
  integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script>
  const platformCrawlerStatusList = {{{ json crawlerStatus }}}
  const modalBody = document.querySelector('.modal-body')
  const modalTitle = document.querySelector('.modal-title')
  const problemProjectBadges = document.querySelectorAll('.js-problem-project-badge')
  problemProjectBadges.forEach(element => {
    element.addEventListener('click', function () {
      const platformId = this.dataset.platformId
      const problemType = this.dataset.problemType
      const numberOfProblemProject = Number(this.dataset.numberOfProblemProject)

      if (numberOfProblemProject === 0) {
        return
      }


      const platform = platformCrawlerStatusList.find(crawlerStatus => crawlerStatus.platformId === platformId)
      const problemProjectList = getProblemProjectList(platform, problemType)
      const problemProjectHTML = getProblemProjectHTML(problemProjectList, problemType)
      const modalTitleText = getModalTitleText(platform, problemType)
      modalBody.innerHTML = problemProjectHTML
      modalTitle.innerHTML = modalTitleText
      $('#modal').modal('show')
    })
  })

  function getProblemProjectList(platform, problemType) {
    const lastIndex = platform.records.length ? platform.records.length - 1 : 0

    if (problemType === 'not-found') {
      return platform.records[lastIndex].notFoundProjects
    } else if (problemType === 'closed') {
      return platform.records[lastIndex].closedProjects
    } else if (problemType === 'no-latest-data') {
      return platform.records[lastIndex].noLatestDataProjects
    } else {
      return []
    }
  }

  function getProblemProjectHTML(problemProjectList, problemType) {
    let badgeType = ''
    if (problemType === 'not-found') {
      badgeType = 'badge-warning'
    } else if (problemType === 'closed') {
      badgeType = 'badge-secondary'
    } else if (problemType === 'no-latest-data') {
      badgeType = 'badge-danger'
    }

    let problemProjectHTML = ''
    problemProjectList.forEach(project => {
      problemProjectHTML += `<a
                    target="_blank" href="${project.pageUrl}" class="badge ${badgeType}">${project.projectId}</a>,`
    })
    return problemProjectHTML
  }

  function getModalTitleText(platform, problemType) {
    if (problemType === 'not-found') {
      return `${platform.platformTitle} 找不到`
    } else if (problemType === 'closed') {
      return `${platform.platformTitle} 已結束`
    } else if (problemType === 'no-latest-data') {
      return `${platform.platformTitle} 有問題`
    } else {
      return ''
    }
  }
</script>